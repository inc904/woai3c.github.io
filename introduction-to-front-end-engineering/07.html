<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>什么时候需要监控 | 带你入门前端工程</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/introduction-to-front-end-engineering/assets/css/0.styles.e026c8d6.css" as="style"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/app.a2b9a5b8.js" as="script"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/2.4a4753f4.js" as="script"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/15.97c6ce9d.js" as="script"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/7.85b148e3.js" as="script"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/10.8d4b01c2.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/11.e429313f.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/12.a81accce.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/13.2a9f7c84.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/14.c596516f.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/16.7f26832c.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/17.47b23890.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/18.79b7a5d0.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/19.a7514f7e.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/20.c421a588.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/3.0b23143a.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/4.139d26a4.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/5.345733b2.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/6.416b4323.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/8.e1e46528.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/9.e653c038.js">
    <link rel="stylesheet" href="/introduction-to-front-end-engineering/assets/css/0.styles.e026c8d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/introduction-to-front-end-engineering/" class="home-link router-link-active"><!----> <span class="site-name">带你入门前端工程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/woai3c/introduction-to-front-end-engineering" target="_blank" rel="noopener noreferrer" class="repo-link">
    给作者的 Github 点个 star 吧！
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/woai3c/introduction-to-front-end-engineering" target="_blank" rel="noopener noreferrer" class="repo-link">
    给作者的 Github 点个 star 吧！
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/introduction-to-front-end-engineering/" aria-current="page" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#注意" class="sidebar-link">注意</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#你会学到什么" class="sidebar-link">你会学到什么？</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#适宜人群" class="sidebar-link">适宜人群</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#扩展" class="sidebar-link">扩展</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#license" class="sidebar-link">License</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#赞助" class="sidebar-link">赞助</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/01.html" class="sidebar-link">1. 技术选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#可控性" class="sidebar-link">可控性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#稳定性" class="sidebar-link">稳定性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#适用性" class="sidebar-link">适用性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#易用性" class="sidebar-link">易用性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/02.html" class="sidebar-link">2. 统一规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#代码规范" class="sidebar-link">代码规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#git-规范" class="sidebar-link">git 规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#项目规范" class="sidebar-link">项目规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#ui-规范" class="sidebar-link">UI 规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/03.html" class="sidebar-link">3. 前端组件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#高内聚-低耦合" class="sidebar-link">高内聚，低耦合</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#模块化、组件化" class="sidebar-link">模块化、组件化</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#web-components" class="sidebar-link">Web Components</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/04.html" class="sidebar-link">4. 测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#单元测试" class="sidebar-link">单元测试</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#e2e-测试" class="sidebar-link">E2E 测试</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/05.html" class="sidebar-link">5. 构建工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#webpack" class="sidebar-link">webpack</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#rollup" class="sidebar-link">rollup</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#vite" class="sidebar-link">vite</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/06.html" class="sidebar-link">6. 自动化部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#gitea-jenkins-自动构建前端项目并部署到服务器" class="sidebar-link">Gitea + Jenkins 自动构建前端项目并部署到服务器</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#github-actions-自动构建前端项目并部署到服务器" class="sidebar-link">Github Actions 自动构建前端项目并部署到服务器</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#部署方式" class="sidebar-link">部署方式</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/07.html" aria-current="page" class="active sidebar-link">7. 前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#什么时候需要监控" class="sidebar-link">什么时候需要监控</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#性能数据采集" class="sidebar-link">性能数据采集</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#错误数据采集" class="sidebar-link">错误数据采集</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#行为数据采集" class="sidebar-link">行为数据采集</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#数据上报" class="sidebar-link">数据上报</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#前端监控部署" class="sidebar-link">前端监控部署</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/08.html" class="sidebar-link">8. 性能优化（一）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/08.html#性能优化分类" class="sidebar-link">性能优化分类</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/08.html#加载时性能优化-10-条规则" class="sidebar-link">加载时性能优化 10 条规则</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/09.html" class="sidebar-link">9. 性能优化（二）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/09.html#运行时性能优化-13-条规则" class="sidebar-link">运行时性能优化 13 条规则</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/10.html" class="sidebar-link">10. 重构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#重构的原则" class="sidebar-link">重构的原则</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#重构的手法" class="sidebar-link">重构的手法</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/11.html" class="sidebar-link">11. 微服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/11.html#微服务实践" class="sidebar-link">微服务实践</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/11.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/12.html" class="sidebar-link">12. Serverless</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#faas" class="sidebar-link">Faas</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#baas" class="sidebar-link">Baas</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#faas-和-baas-的区别" class="sidebar-link">Faas 和 Baas 的区别</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#阿里云-faas-实践" class="sidebar-link">阿里云 Faas 实践</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#小结" class="sidebar-link">小结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="什么时候需要监控"><a href="#什么时候需要监控" class="header-anchor">#</a> 什么时候需要监控</h2> <ol><li>当你的应用频繁报错找不到原因的时候。</li> <li>需要分析用户兴趣爱好、购买习惯。</li> <li>需要优化程序的时候，可以做监控收集数据，做针对性的优化。</li> <li>需要保证服务可靠性稳定性。</li></ol> <div id="ad-div" data-id="204" class="wwads-cn wwads-vertical wwads-sticky" style="max-width:154px;"></div> <p>如果你的应用符合以上任意一条，就可以对应用实行监控了。监控的作用有两个：事前预警和事后分析。</p> <p><strong>事前预警</strong>：提前设置一个阈值，当监控的数据达到阈值时，通过短信或者邮件通知管理员。例如 API 请求数量突然间暴涨，就得进行报警，否则可能会造成服务器宕机。</p> <p><strong>事后分析</strong>：通过监控日志文件，分析故障原因和故障发生点。从而做出修改，防止这种情况再次发生。</p> <p>本章内容分为前端监控原理分析和如何对项目实行监控两个部分。第一部分是讲如何写一个简易的监控 SDK，第二部分是讲如何使用 <a href="https://docs.sentry.io/" target="_blank" rel="noopener noreferrer">sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现项目监控。</p> <p>好了，下面让我们开始进入正文吧。</p> <p>一个完整的前端监控平台包括三个部分：数据采集与上报、数据整理和存储、数据展示。</p> <p>本章要讲的就是其中的第一个环节——数据采集与上报。下图是本章要讲述内容的大纲，大家可以先大致了解一下：</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b1503db00065b0bde7edd1b45abd1f85.png" alt="image.png"></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b35bc4f1cdd718025cf39818772ad761.png" alt="image.png"></p> <p>仅看理论知识是比较难以理解的，为此我结合本章要讲的技术要点写了一个简单的<a href="https://github.com/woai3c/monitor-demo" target="_blank" rel="noopener noreferrer">监控 SDK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，可以用它来写一些简单的 DEMO，帮助加深理解。再结合本章一起阅读，效果更好。</p> <h2 id="性能数据采集"><a href="#性能数据采集" class="header-anchor">#</a> 性能数据采集</h2> <p>chrome 开发团队提出了一系列用于检测网页性能的指标：</p> <ul><li>FP(first-paint)，从页面加载开始到第一个像素绘制到屏幕上的时间</li> <li>FCP(first-contentful-paint)，从页面加载开始到页面内容的任何部分在屏幕上完成渲染的时间</li> <li>LCP(largest-contentful-paint)，从页面加载开始到最大文本块或图像元素在屏幕上完成渲染的时间</li> <li>CLS(layout-shift)，从页面加载开始和其<a href="https://developers.google.com/web/updates/2018/07/page-lifecycle-api" target="_blank" rel="noopener noreferrer">生命周期状态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>变为隐藏期间发生的所有意外布局偏移的累积分数</li></ul> <p>这四个性能指标都需要通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver" target="_blank" rel="noopener noreferrer">PerformanceObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来获取（也可以通过 <code>performance.getEntriesByName()</code> 获取，但它不是在事件触发时通知的）。PerformanceObserver 是一个性能监测对象，用于监测性能度量事件。</p> <h3 id="fp"><a href="#fp" class="header-anchor">#</a> FP</h3> <p>FP(first-paint)，从页面加载开始到第一个像素绘制到屏幕上的时间。其实把 FP 理解成白屏时间也是没问题的。</p> <p>测量代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'first-paint'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
<span class="token comment">// buffered 属性表示是否观察缓存数据，也就是说观察代码添加时机比事情触发时机晚也没关系。</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'paint'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过以上代码可以得到 FP 的内容:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    duration<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    entryType<span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;first-paint&quot;</span><span class="token punctuation">,</span>
    startTime<span class="token operator">:</span> <span class="token number">359</span><span class="token punctuation">,</span> <span class="token comment">// fp 时间</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>startTime</code> 就是我们要的绘制时间。</p> <h3 id="fcp"><a href="#fcp" class="header-anchor">#</a> FCP</h3> <p>FCP(first-contentful-paint)，从页面加载开始到页面内容的任何部分在屏幕上完成渲染的时间。对于该指标，&quot;内容&quot;指的是文本、图像（包括背景图像）、<code>&lt;svg&gt;</code>元素或非白色的<code>&lt;canvas&gt;</code>元素。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/15d7a6a836ea6a6ec36160e4489acd9c.png" alt="image.png"></p> <p>为了提供良好的用户体验，FCP 的分数应该控制在 1.8 秒以内。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/fb9054a8ec9c9f817ec30d1c539890e2.png" alt="image.png"></p> <p>测量代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'first-contentful-paint'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'paint'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过以上代码可以得到 FCP 的内容:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    duration<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    entryType<span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;first-contentful-paint&quot;</span><span class="token punctuation">,</span>
    startTime<span class="token operator">:</span> <span class="token number">459</span><span class="token punctuation">,</span> <span class="token comment">// fcp 时间</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>startTime</code> 就是我们要的绘制时间。</p> <h3 id="lcp"><a href="#lcp" class="header-anchor">#</a> LCP</h3> <p>LCP(largest-contentful-paint)，从页面加载开始到最大文本块或图像元素在屏幕上完成渲染的时间。LCP 指标会根据页面<a href="https://w3c.github.io/hr-time/#timeorigin-attribute" target="_blank" rel="noopener noreferrer">首次开始加载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的时间点来报告可视区域内可见的最大<a href="https://web.dev/lcp/#what-elements-are-considered" target="_blank" rel="noopener noreferrer">图像或文本块<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>完成渲染的相对时间。</p> <p>一个良好的 LCP 分数应该控制在 2.5 秒以内。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/12c675a73683c88866d313414d678908.png" alt="image.png"></p> <p>测量代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'largest-contentful-paint'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>通过以上代码可以得到 LCP 的内容:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    duration<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    element<span class="token operator">:</span> p<span class="token punctuation">,</span>
    entryType<span class="token operator">:</span> <span class="token string">&quot;largest-contentful-paint&quot;</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    loadTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    renderTime<span class="token operator">:</span> <span class="token number">1021.299</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token number">37932</span><span class="token punctuation">,</span>
    startTime<span class="token operator">:</span> <span class="token number">1021.299</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>startTime</code> 就是我们要的绘制时间。element 是指 LCP 绘制的 DOM 元素。</p> <p>FCP 和 LCP 的区别是：FCP 只要任意内容绘制完成就触发，LCP 是最大内容渲染完成时触发。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/39e0b18963a20a61623cc7288fd04ff4.png" alt="image.png"></p> <p>LCP 考察的元素类型为：</p> <ul><li><code>&lt;img&gt;</code>元素</li> <li>内嵌在<code>&lt;svg&gt;</code>元素内的<code>&lt;image&gt;</code>元素</li> <li><code>&lt;video&gt;</code>元素（使用封面图像）</li> <li>通过<a href="https://developer.mozilla.org/docs/Web/CSS/url()" target="_blank" rel="noopener noreferrer"><code>url()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数（而非使用<a href="https://developer.mozilla.org/docs/Web/CSS/CSS_Images/Using_CSS_gradients" target="_blank" rel="noopener noreferrer">CSS 渐变<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）加载的带有背景图像的元素</li> <li>包含文本节点或其他行内级文本元素子元素的<a href="https://developer.mozilla.org/docs/Web/HTML/Block-level_elements" target="_blank" rel="noopener noreferrer">块级元素<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h3 id="cls"><a href="#cls" class="header-anchor">#</a> CLS</h3> <p>CLS(layout-shift)，从页面加载开始和其<a href="https://developers.google.com/web/updates/2018/07/page-lifecycle-api" target="_blank" rel="noopener noreferrer">生命周期状态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>变为隐藏期间发生的所有意外布局偏移的累积分数。</p> <p>布局偏移分数的计算方式如下：</p> <div class="language- extra-class"><pre class="language-text"><code>布局偏移分数 = 影响分数 * 距离分数
</code></pre></div><blockquote><p><a href="https://github.com/WICG/layout-instability#Impact-Fraction" target="_blank" rel="noopener noreferrer">影响分数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>测量<em>不稳定元素</em>对两帧之间的可视区域产生的影响。</p></blockquote> <blockquote><p><em>距离分数</em>指的是任何<em>不稳定元素</em>在一帧中位移的最大距离（水平或垂直）除以可视区域的最大尺寸维度（宽度或高度，以较大者为准）。</p></blockquote> <p><strong>CLS 就是把所有布局偏移分数加起来的总和</strong>。</p> <p>当一个 DOM 在两个渲染帧之间产生了位移，就会触发 CLS（如图所示）。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/1f429ba1e165d77058c6b5e9fe502a8a.png" alt="image.png"></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/948a1c2a8824e98c1d8e27d66fc83a74.png" alt="image.png"></p> <p>上图中的矩形从左上角移动到了右边，这就算是一次布局偏移。同时，在 CLS 中，有一个叫<strong>会话窗口</strong>的术语：一个或多个快速连续发生的单次布局偏移，每次偏移相隔的时间少于 1 秒，且整个窗口的最大持续时长为 5 秒。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b119d115d2f0ebbcbe7ff847e42e1a14.png" alt="image.png"></p> <p>例如上图中的第二个会话窗口，它里面有四次布局偏移，每一次偏移之间的间隔必须少于 1 秒，并且第一个偏移和最后一个偏移之间的时间不能超过 5 秒，这样才能算是一次会话窗口。如果不符合这个条件，就算是一个新的会话窗口。可能有人会问，为什么要这样规定？其实这是 chrome 团队根据大量的实验和研究得出的分析结果 <a href="https://web.dev/evolving-cls/" target="_blank" rel="noopener noreferrer">Evolving the CLS metric<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>CLS 一共有三种计算方式：</p> <ol><li>累加</li> <li>取所有会话窗口的平均数</li> <li>取所有会话窗口中的最大值</li></ol> <h4 id="累加"><a href="#累加" class="header-anchor">#</a> 累加</h4> <p>也就是把从页面加载开始的所有布局偏移分数加在一起。但是这种计算方式对生命周期长的页面不友好，页面存留时间越长，CLS 分数越高。</p> <h4 id="取所有会话窗口的平均数"><a href="#取所有会话窗口的平均数" class="header-anchor">#</a> 取所有会话窗口的平均数</h4> <p>这种计算方式不是按单个布局偏移为单位，而是以会话窗口为单位。将所有会话窗口的值相加再取平均值。但是这种计算方式也有缺点。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/c21455d2be6fe2436b749ad862daf25f.png" alt="image.png"></p> <p>从上图可以看出来，第一个会话窗口产生了比较大的 CLS 分数，第二个会话窗口产生了比较小的 CLS 分数。如果取它们的平均值来当做 CLS 分数，则根本看不出来页面的运行状况。原来页面是早期偏移多，后期偏移少，现在的平均值无法反映出这种情况。</p> <h4 id="取所有会话窗口中的最大值"><a href="#取所有会话窗口中的最大值" class="header-anchor">#</a> 取所有会话窗口中的最大值</h4> <p>这种方式是目前最优的计算方式，每次只取所有会话窗口的最大值，用来反映页面布局偏移的最差情况。详情请看 <a href="https://web.dev/evolving-cls/" target="_blank" rel="noopener noreferrer">Evolving the CLS metric<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>下面是第三种计算方式的测量代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sessionValue <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> sessionEntries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> cls <span class="token operator">=</span> <span class="token punctuation">{</span>
    subType<span class="token operator">:</span> <span class="token string">'layout-shift'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'layout-shift'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
    pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only count layout shifts without recent user input.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>hadRecentInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> firstSessionEntry <span class="token operator">=</span> sessionEntries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">const</span> lastSessionEntry <span class="token operator">=</span> sessionEntries<span class="token punctuation">[</span>sessionEntries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

            <span class="token comment">// If the entry occurred less than 1 second after the previous entry and</span>
            <span class="token comment">// less than 5 seconds after the first entry in the session, include the</span>
            <span class="token comment">// entry in the current session. Otherwise, start a new session.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                sessionValue
                <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>startTime <span class="token operator">-</span> lastSessionEntry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> <span class="token number">1000</span>
                <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>startTime <span class="token operator">-</span> firstSessionEntry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> <span class="token number">5000</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sessionValue <span class="token operator">+=</span> entry<span class="token punctuation">.</span>value
                sessionEntries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">formatCLSEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sessionValue <span class="token operator">=</span> entry<span class="token punctuation">.</span>value
                sessionEntries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">formatCLSEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If the current session value is larger than the current CLS value,</span>
            <span class="token comment">// update CLS and the entries contributing to it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionValue <span class="token operator">&gt;</span> cls<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cls<span class="token punctuation">.</span>value <span class="token operator">=</span> sessionValue
                cls<span class="token punctuation">.</span>entries <span class="token operator">=</span> sessionEntries
                cls<span class="token punctuation">.</span>startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token function">deepCopy</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'layout-shift'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在看完上面的文字描述后，再看代码就好理解了。一次布局偏移的测量内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  duration<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  entryType<span class="token operator">:</span> <span class="token string">&quot;layout-shift&quot;</span><span class="token punctuation">,</span>
  hadRecentInput<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  lastInputTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  sources<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>LayoutShiftAttribution<span class="token punctuation">,</span> LayoutShiftAttribution<span class="token punctuation">]</span><span class="token punctuation">,</span>
  startTime<span class="token operator">:</span> <span class="token number">1176.199999999255</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token number">0.000005752046026677329</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码中的 <code>value</code> 字段就是布局偏移分数。</p> <h3 id="domcontentloaded、load-事件"><a href="#domcontentloaded、load-事件" class="header-anchor">#</a> DOMContentLoaded、load 事件</h3> <p>当纯 HTML 被完全加载以及解析时，<code>DOMContentLoaded</code> 事件会被触发，不用等待 css、img、iframe 加载完。</p> <p>当整个页面及所有依赖资源如样式表和图片都已完成加载时，将触发 <code>load</code> 事件。</p> <p>虽然这两个性能指标比较旧了，但是它们仍然能反映页面的一些情况。对于它们进行监听仍然是必要的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> lazyReportCache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/report'</span>

<span class="token punctuation">[</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token string">'DOMContentLoaded'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> type<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="首屏渲染时间"><a href="#首屏渲染时间" class="header-anchor">#</a> 首屏渲染时间</h3> <p>大多数情况下，首屏渲染时间可以通过 <code>load</code> 事件获取。除了一些特殊情况，例如异步加载的图片和 DOM。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            &lt;div&gt;
                &lt;!-- 省略一堆代码... --&gt;
            &lt;/div&gt;
        </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>像这种情况就无法通过 <code>load</code> 事件获取首屏渲染时间了。这时我们需要通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来获取首屏渲染时间。MutationObserver 在监听的 DOM 元素属性发生变化时会触发事件。</p> <p>首屏渲染时间计算过程：</p> <ol><li>利用 MutationObserver 监听 document 对象，每当 DOM 元素属性发生变更时，触发事件。</li> <li>判断该 DOM 元素是否在首屏内，如果在，则在 <code>requestAnimationFrame()</code> 回调函数中调用 <code>performance.now()</code> 获取当前时间，作为它的绘制时间。</li> <li>将最后一个 DOM 元素的绘制时间和首屏中所有加载的图片时间作对比，将最大值作为首屏渲染时间。</li></ol> <h4 id="监听-dom"><a href="#监听-dom" class="header-anchor">#</a> 监听 DOM</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> next <span class="token operator">=</span> window<span class="token punctuation">.</span>requestAnimationFrame <span class="token operator">?</span> requestAnimationFrame <span class="token operator">:</span> setTimeout
<span class="token keyword">const</span> ignoreDOMList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'STYLE'</span><span class="token punctuation">,</span> <span class="token string">'SCRIPT'</span><span class="token punctuation">,</span> <span class="token string">'LINK'</span><span class="token punctuation">]</span>
    
observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token parameter">mutationList</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token punctuation">{</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mutation <span class="token keyword">of</span> mutationList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>addedNodes<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token function">isInScreen</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span>startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    childList<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    subtree<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码就是监听 DOM 变化的代码，同时需要过滤掉 <code>style</code>、<code>script</code>、<code>link</code> 等标签。</p> <h4 id="判断是否在首屏"><a href="#判断是否在首屏" class="header-anchor">#</a> 判断是否在首屏</h4> <p>一个页面的内容可能非常多，但用户最多只能看见一屏幕的内容。所以在统计首屏渲染时间的时候，需要限定范围，把渲染内容限定在当前屏幕内。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> viewportWidth <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth
<span class="token keyword">const</span> viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight

<span class="token comment">// dom 对象是否在屏幕内</span>
<span class="token keyword">function</span> <span class="token function">isInScreen</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rectInfo <span class="token operator">=</span> dom<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rectInfo<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> viewportWidth <span class="token operator">&amp;&amp;</span> rectInfo<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> viewportHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用-requestanimationframe-获取-dom-绘制时间"><a href="#使用-requestanimationframe-获取-dom-绘制时间" class="header-anchor">#</a> 使用 <code>requestAnimationFrame()</code> 获取 DOM 绘制时间</h4> <p>当 DOM 变更触发 MutationObserver 事件时，只是代表 DOM 内容可以被读取到，并不代表该 DOM 被绘制到了屏幕上。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/083902c92554f4953a1011620350db2b.png" alt="image.png"></p> <p>从上图可以看出，当触发 MutationObserver 事件时，可以读取到 <code>document.body</code> 上已经有内容了，但实际上左边的屏幕并没有绘制任何内容。所以要调用 <code>requestAnimationFrame()</code> 在浏览器绘制成功后再获取当前时间作为 DOM 绘制时间。</p> <h4 id="和首屏内的所有图片加载时间作对比"><a href="#和首屏内的所有图片加载时间作对比" class="header-anchor">#</a> 和首屏内的所有图片加载时间作对比</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getRenderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime <span class="token operator">&gt;</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            startTime <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 需要和当前页面所有加载图片的时间做对比，取最大值</span>
    <span class="token comment">// 图片请求时间要小于 startTime，响应结束时间要大于 startTime</span>
    performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'resource'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            item<span class="token punctuation">.</span>initiatorType <span class="token operator">===</span> <span class="token string">'img'</span>
            <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>fetchStart <span class="token operator">&lt;</span> startTime 
            <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>responseEnd <span class="token operator">&gt;</span> startTime
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            startTime <span class="token operator">=</span> item<span class="token punctuation">.</span>responseEnd
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> startTime
<span class="token punctuation">}</span>
</code></pre></div><h4 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h4> <p>现在的代码还没优化完，主要有两点注意事项：</p> <ol><li>什么时候上报渲染时间？</li> <li>如果兼容异步添加 DOM 的情况？</li></ol> <p>第一点，必须要在 DOM 不再变化后再上报渲染时间，一般 load 事件触发后，DOM 就不再变化了。所以我们可以在这个时间点进行上报。</p> <p>第二点，可以在 LCP 事件触发后再进行上报。不管是同步还是异步加载的 DOM，它都需要进行绘制，所以可以监听 LCP 事件，在该事件触发后才允许进行上报。</p> <p>将以上两点方案结合在一起，就有了以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> isOnLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token function">executeAfterLoad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    isOnLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">let</span> timer
<span class="token keyword">let</span> observer
<span class="token keyword">function</span> <span class="token function">checkDOMChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等 load、lcp 事件触发后并且 DOM 树不再变化时，计算首屏渲染时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnLoaded <span class="token operator">&amp;&amp;</span> <span class="token function">isLCPDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer <span class="token operator">&amp;&amp;</span> observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
                subType<span class="token operator">:</span> <span class="token string">'first-screen-paint'</span><span class="token punctuation">,</span>
                startTime<span class="token operator">:</span> <span class="token function">getRenderTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            entries <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">checkDOMChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>checkDOMChange()</code> 代码每次在触发 MutationObserver 事件时进行调用，需要用防抖函数进行处理。</p> <h3 id="接口请求耗时"><a href="#接口请求耗时" class="header-anchor">#</a> 接口请求耗时</h3> <p>接口请求耗时需要对 XMLHttpRequest 和 fetch 进行监听。</p> <p><strong>监听 XMLHttpRequest</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>originalProto<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newOpen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token function">originalOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

originalProto<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newSend</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token function-variable function">onLoadend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTime <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime

        <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> url<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">const</span> reportData <span class="token operator">=</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">,</span>
            duration<span class="token punctuation">,</span>
            startTime<span class="token punctuation">,</span>
            endTime<span class="token punctuation">,</span>
            url<span class="token punctuation">,</span>
            method<span class="token operator">:</span> <span class="token punctuation">(</span>method <span class="token operator">||</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            success<span class="token operator">:</span> status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'xhr'</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'loadend'</span><span class="token punctuation">,</span> onLoadend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadend'</span><span class="token punctuation">,</span> onLoadend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">originalSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如何判断 XML 请求是否成功？可以根据他的状态码是否在 200~299 之间。如果在，那就是成功，否则失败。</p> <p><strong>监听 fetch</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> originalFetch <span class="token operator">=</span> window<span class="token punctuation">.</span>fetch

<span class="token keyword">function</span> <span class="token function">overwriteFetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">newFetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> reportData <span class="token operator">=</span> <span class="token punctuation">{</span>
            startTime<span class="token punctuation">,</span>
            url<span class="token punctuation">,</span>
            method<span class="token operator">:</span> <span class="token punctuation">(</span>config<span class="token operator">?.</span>method <span class="token operator">||</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">originalFetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            reportData<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>duration <span class="token operator">=</span> reportData<span class="token punctuation">.</span>endTime <span class="token operator">-</span> reportData<span class="token punctuation">.</span>startTime

            <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>status <span class="token operator">=</span> data<span class="token punctuation">.</span>status
            reportData<span class="token punctuation">.</span>success <span class="token operator">=</span> data<span class="token punctuation">.</span>ok

            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            reportData<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportData<span class="token punctuation">.</span>duration <span class="token operator">=</span> reportData<span class="token punctuation">.</span>endTime <span class="token operator">-</span> reportData<span class="token punctuation">.</span>startTime
            reportData<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span>
            reportData<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">false</span>

            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span>reportData<span class="token punctuation">)</span>

            <span class="token keyword">throw</span> err
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于 fetch，可以根据返回数据中的的 <code>ok</code> 字段判断请求是否成功，如果为 <code>true</code> 则请求成功，否则失败。</p> <p><strong>注意</strong>，监听到的接口请求时间和 chrome devtool 上检测到的时间可能不一样。这是因为 chrome devtool 上检测到的是 HTTP 请求发送和接口整个过程的时间。但是 xhr 和 fetch 是异步请求，接口请求成功后需要调用回调函数。事件触发时会把回调函数放到消息队列，然后浏览器再处理，这中间也有一个等待过程。</p> <h3 id="资源加载时间、缓存命中率"><a href="#资源加载时间、缓存命中率" class="header-anchor">#</a> 资源加载时间、缓存命中率</h3> <p>通过 <code>PerformanceObserver</code> 可以监听 <code>resource</code> 和 <code>navigation</code> 事件，如果浏览器不支持 <code>PerformanceObserver</code>，还可以通过 <code>performance.getEntriesByType(entryType)</code> 来进行降级处理。</p> <p>当 <code>resource</code> 事件触发时，可以获取到对应的资源列表，每个资源对象包含以下一些字段：</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/41b2790d8539720faaa7c95b29fb6039.png" alt="image.png"></p> <p>从这些字段中我们可以提取到一些有用的信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    name<span class="token operator">:</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token comment">// 资源名称</span>
    subType<span class="token operator">:</span> entryType<span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
    sourceType<span class="token operator">:</span> entry<span class="token punctuation">.</span>initiatorType<span class="token punctuation">,</span> <span class="token comment">// 资源类型</span>
    duration<span class="token operator">:</span> entry<span class="token punctuation">.</span>duration<span class="token punctuation">,</span> <span class="token comment">// 资源加载耗时</span>
    dns<span class="token operator">:</span> entry<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>domainLookupStart<span class="token punctuation">,</span> <span class="token comment">// DNS 耗时</span>
    tcp<span class="token operator">:</span> entry<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>connectStart<span class="token punctuation">,</span> <span class="token comment">// 建立 tcp 连接耗时</span>
    redirect<span class="token operator">:</span> entry<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> entry<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span> <span class="token comment">// 重定向耗时</span>
    ttfb<span class="token operator">:</span> entry<span class="token punctuation">.</span>responseStart<span class="token punctuation">,</span> <span class="token comment">// 首字节时间</span>
    protocol<span class="token operator">:</span> entry<span class="token punctuation">.</span>nextHopProtocol<span class="token punctuation">,</span> <span class="token comment">// 请求协议</span>
    responseBodySize<span class="token operator">:</span> entry<span class="token punctuation">.</span>encodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 响应内容大小</span>
    responseHeaderSize<span class="token operator">:</span> entry<span class="token punctuation">.</span>transferSize <span class="token operator">-</span> entry<span class="token punctuation">.</span>encodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 响应头部大小</span>
    resourceSize<span class="token operator">:</span> entry<span class="token punctuation">.</span>decodedBodySize<span class="token punctuation">,</span> <span class="token comment">// 资源解压后的大小</span>
    isCache<span class="token operator">:</span> <span class="token function">isCache</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否命中缓存</span>
    startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>判断该资源是否命中缓存</strong></p> <p>在这些资源对象中有一个  <code>transferSize</code> 字段，它表示获取资源的大小，包括响应头字段和响应数据的大小。如果这个值为 0，说明是从缓存中直接读取的（强制缓存）。如果这个值不为 0，但是 <code>encodedBodySize</code> 字段为 0，说明它走的是协商缓存（<code>encodedBodySize</code> 表示请求响应数据 body 的大小）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isCache</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接从缓存读取或 304</span>
    <span class="token keyword">return</span> entry<span class="token punctuation">.</span>transferSize <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>transferSize <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>encodedBodySize <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不符合以上条件的，说明未命中缓存。然后将<code>所有命中缓存的数据/总数据</code>就能得出缓存命中率。</p> <h3 id="浏览器往返缓存-bfc-back-forward-cache"><a href="#浏览器往返缓存-bfc-back-forward-cache" class="header-anchor">#</a> 浏览器往返缓存 BFC（back/forward cache）</h3> <p>bfcache 是一种内存缓存，它会将整个页面保存在内存中。当用户返回时可以马上看到整个页面，而不用再次刷新。据该文章 <a href="https://web.dev/bfcache/" target="_blank" rel="noopener noreferrer">bfcache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 介绍，firefox 和 safari 一直支持 bfc，chrome 只有在高版本的移动端浏览器支持。但我试了一下，只有 safari 浏览器支持，可能我的 firefox 版本不对。</p> <p>但是 bfc 也是有缺点的，当用户返回并从 bfc 中恢复页面时，原来页面的代码不会再次执行。为此，浏览器提供了一个 <code>pageshow</code> 事件，可以把需要再次执行的代码放在里面。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pageshow'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果该属性为 true，表示是从 bfc 中恢复的页面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This page was restored from the bfcache.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This page was loaded normally.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从 bfc 中恢复的页面，我们也需要收集他们的 FP、FCP、LCP 等各种时间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">onBFCacheRestore</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token string">'first-paint'</span><span class="token punctuation">,</span> <span class="token string">'first-contentful-paint'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
                name<span class="token operator">:</span> type<span class="token punctuation">,</span>
                subType<span class="token operator">:</span> type<span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
                pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bfc<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码很好理解，在 <code>pageshow</code> 事件触发后，用当前时间减去事件触发时间，这个时间差值就是性能指标的绘制时间。<strong>注意</strong>，从 bfc 中恢复的页面的这些性能指标，值一般都很小，一般在 10 ms 左右。所以要给它们加个标识字段 <code>bfc: true</code>。这样在做性能统计时可以对它们进行忽略。</p> <h3 id="fps"><a href="#fps" class="header-anchor">#</a> FPS</h3> <p>利用 <code>requestAnimationFrame()</code> 我们可以计算当前页面的 FPS。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> next <span class="token operator">=</span> window<span class="token punctuation">.</span>requestAnimationFrame 
    <span class="token operator">?</span> <span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> frames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">fps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> frame <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> lastSecond <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">calculateFPS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame<span class="token operator">++</span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastSecond <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 由于 now - lastSecond 的单位是毫秒，所以 frame 要 * 1000</span>
            <span class="token keyword">const</span> fps <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>frame <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastSecond<span class="token punctuation">)</span><span class="token punctuation">)</span>
            frames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fps<span class="token punctuation">)</span>
                
            frame <span class="token operator">=</span> <span class="token number">0</span>
            lastSecond <span class="token operator">=</span> now
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 避免上报太快，缓存一定数量再上报</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frames<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">report</span><span class="token punctuation">(</span><span class="token function">deepCopy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                frames<span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'performace'</span><span class="token punctuation">,</span>
                subType<span class="token operator">:</span> <span class="token string">'fps'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
            frames<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token function">next</span><span class="token punctuation">(</span>calculateFPS<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">calculateFPS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码逻辑如下：</p> <ol><li>先记录一个初始时间，然后每次触发 <code>requestAnimationFrame()</code> 时，就将帧数加 1。过去一秒后用<code>帧数/流逝的时间</code>就能得到当前帧率。</li></ol> <p>当连续三个低于 20 的 FPS 出现时，我们可以断定页面出现了卡顿，详情请看 <a href="https://zhuanlan.zhihu.com/p/39292837" target="_blank" rel="noopener noreferrer">如何监控网页的卡顿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token parameter">fpsList<span class="token punctuation">,</span> below <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fpsList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> fpsList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> below<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue-路由变更渲染时间"><a href="#vue-路由变更渲染时间" class="header-anchor">#</a> Vue 路由变更渲染时间</h3> <p>首屏渲染时间我们已经知道如何计算了，但是如何计算 SPA 应用的页面路由切换导致的页面渲染时间呢？本章用 Vue 作为示例，讲一下我的思路。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onVueRouter</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">let</span> startTime
    router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次进入页面已经有其他统计的渲染时间可用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isFirst <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 给 router 新增一个字段，表示是否要计算渲染时间</span>
        <span class="token comment">// 只有路由跳转才需要计算</span>
        router<span class="token punctuation">.</span>needCalculateRenderTime <span class="token operator">=</span> <span class="token boolean">true</span>
        startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> timer
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>router<span class="token punctuation">.</span>needCalculateRenderTime<span class="token punctuation">)</span> <span class="token keyword">return</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 仅在整个视图都被渲染之后才会运行的代码</span>
                <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>

                timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    router<span class="token punctuation">.</span>needCalculateRenderTime <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        type<span class="token operator">:</span> <span class="token string">'performance'</span><span class="token punctuation">,</span>
                        subType<span class="token operator">:</span> <span class="token string">'vue-router-change-paint'</span><span class="token punctuation">,</span>
                        duration<span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
                        startTime<span class="token operator">:</span> now<span class="token punctuation">,</span>
                        pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码逻辑如下：</p> <ol><li>监听路由钩子，在路由切换时会触发 <code>router.beforeEach()</code> 钩子，在该钩子的回调函数里将当前时间记为渲染开始时间。</li> <li>利用 <code>Vue.mixin()</code> 对所有组件的 <code>mounted()</code> 注入一个函数。每个函数都执行一个防抖函数。</li> <li>当最后一个组件的 <code>mounted()</code> 触发时，就代表该路由下的所有组件已经挂载完毕。可以在 <code>this.$nextTick()</code> 回调函数中获取渲染时间。</li></ol> <p>同时，还要考虑到一个情况。不切换路由时，也会有变更组件的情况，这时不应该在这些组件的 <code>mounted()</code> 里进行渲染时间计算。所以需要添加一个 <code>needCalculateRenderTime</code> 字段，当切换路由时将它设为 true，代表可以计算渲染时间了。</p> <h2 id="错误数据采集"><a href="#错误数据采集" class="header-anchor">#</a> 错误数据采集</h2> <h3 id="资源加载错误"><a href="#资源加载错误" class="header-anchor">#</a> 资源加载错误</h3> <p>使用 <code>addEventListener()</code> 监听 error 事件，可以捕获到资源加载失败错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 捕获资源加载失败错误 js css img...</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'resource'</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> e<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
            html<span class="token operator">:</span> target<span class="token punctuation">.</span>outerHTML<span class="token punctuation">,</span>
            resourceType<span class="token operator">:</span> target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
            paths<span class="token operator">:</span> e<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span>
            pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="js-错误"><a href="#js-错误" class="header-anchor">#</a> js 错误</h3> <p>使用 <code>window.onerror</code> 可以监听 js 错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听 js 错误</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> line<span class="token punctuation">,</span> column<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        msg<span class="token punctuation">,</span>
        line<span class="token punctuation">,</span>
        column<span class="token punctuation">,</span>
        error<span class="token operator">:</span> error<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
        subType<span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
        pageURL<span class="token operator">:</span> url<span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
        startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-错误"><a href="#promise-错误" class="header-anchor">#</a> promise 错误</h3> <p>使用 <code>addEventListener()</code> 监听 unhandledrejection 事件，可以捕获到未处理的 promise 错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听 promise 错误 缺点是获取不到列数据</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        reason<span class="token operator">:</span> e<span class="token punctuation">.</span>reason<span class="token operator">?.</span>stack<span class="token punctuation">,</span>
        subType<span class="token operator">:</span> <span class="token string">'promise'</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
        startTime<span class="token operator">:</span> e<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
        pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="sourcemap"><a href="#sourcemap" class="header-anchor">#</a> sourcemap</h3> <p>一般生产环境的代码都是经过压缩的，并且生产环境不会把 sourcemap 文件上传。所以生产环境上的代码报错信息是很难读的。因此，我们可以利用 <a href="https://github.com/mozilla/source-map" target="_blank" rel="noopener noreferrer">source-map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来对这些压缩过的代码报错信息进行还原。</p> <p>当代码报错时，我们可以获取到对应的文件名、行数、列数:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    column<span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
    file<span class="token operator">:</span> <span class="token string">'https:/www.xxx.com/bundlejs'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后调用下面的代码进行还原：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mapObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">getMapFileContent</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">sourceMap<span class="token punctuation">.</span>SourceMapConsumer</span><span class="token punctuation">(</span>mapObj<span class="token punctuation">)</span>
    <span class="token comment">// 将 webpack://source-map-demo/./src/index.js 文件中的 ./ 去掉</span>
    <span class="token keyword">const</span> sources <span class="token operator">=</span> mapObj<span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token function">format</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 根据压缩后的报错信息得出未压缩前的报错行列数和源码文件</span>
    <span class="token keyword">const</span> originalInfo <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">originalPositionFor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> line<span class="token operator">:</span> error<span class="token punctuation">.</span>line<span class="token punctuation">,</span> column<span class="token operator">:</span> error<span class="token punctuation">.</span>column <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// sourcesContent 中包含了各个文件的未压缩前的源码，根据文件名找出对应的源码</span>
    <span class="token keyword">const</span> originalFileContent <span class="token operator">=</span> mapObj<span class="token punctuation">.</span>sourcesContent<span class="token punctuation">[</span>sources<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>originalInfo<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        file<span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        content<span class="token operator">:</span> originalFileContent<span class="token punctuation">,</span>
        line<span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>line<span class="token punctuation">,</span>
        column<span class="token operator">:</span> originalInfo<span class="token punctuation">.</span>column<span class="token punctuation">,</span>
        msg<span class="token operator">:</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">,</span>
        error<span class="token operator">:</span> error<span class="token punctuation">.</span>error
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\.\/)*</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getMapFileContent</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./maps/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.map</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每次项目打包时，如果开启了 sourcemap，那么每一个 js 文件都会有一个对应的 map 文件。</p> <div class="language- extra-class"><pre class="language-text"><code>bundle.js
bundle.js.map
</code></pre></div><p>这时 js 文件放在静态服务器上供用户访问，map 文件存储在服务器，用于还原错误信息。<code>source-map</code> 库可以根据压缩过的代码报错信息还原出未压缩前的代码报错信息。例如压缩后报错位置为 <code>1 行 47 列</code>，还原后真正的位置可能为 <code>4 行 10 列</code>。除了位置信息，还可以获取到源码原文。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/c5a0433b715d63d2f741b4fd9593f2da.png" alt="image.png"></p> <p>上图就是一个代码报错还原后的示例。鉴于这部分内容不属于 SDK 的范围，所以我另开了一个 <a href="https://github.com/woai3c/source-map-demo" target="_blank" rel="noopener noreferrer">仓库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来做这个事，有兴趣可以看看。</p> <h3 id="vue-错误"><a href="#vue-错误" class="header-anchor">#</a> Vue 错误</h3> <p>利用 <code>window.onerror</code> 是捕获不到 Vue 错误的，它需要使用 Vue 提供的 API 进行监听。</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将报错信息打印到控制台</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        info<span class="token punctuation">,</span>
        error<span class="token operator">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
        subType<span class="token operator">:</span> <span class="token string">'vue'</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
        startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="行为数据采集"><a href="#行为数据采集" class="header-anchor">#</a> 行为数据采集</h2> <h3 id="pv、uv"><a href="#pv、uv" class="header-anchor">#</a> PV、UV</h3> <p>PV(page view) 是页面浏览量，UV(Unique visitor)用户访问量。PV 只要访问一次页面就算一次，UV 同一天内多次访问只算一次。</p> <p>对于前端来说，只要每次进入页面上报一次 PV 就行，UV 的统计放在服务端来做，主要是分析上报的数据来统计得出 UV。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
        subType<span class="token operator">:</span> <span class="token string">'pv'</span><span class="token punctuation">,</span>
        startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        referrer<span class="token operator">:</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>
        uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="页面停留时长"><a href="#页面停留时长" class="header-anchor">#</a> 页面停留时长</h3> <p>用户进入页面记录一个初始时间，用户离开页面时用当前时间减去初始时间，就是用户停留时长。这个计算逻辑可以放在 <code>beforeunload</code> 事件里做。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageAccessDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onBeforeunload</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'page-access-duration'</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="页面访问深度"><a href="#页面访问深度" class="header-anchor">#</a> 页面访问深度</h3> <p>记录页面访问深度是很有用的，例如不同的活动页面 a 和 b。a 平均访问深度只有 50%，b 平均访问深度有 80%，说明 b 更受用户喜欢，根据这一点可以有针对性的修改 a 活动页面。</p> <p>除此之外还可以利用访问深度以及停留时长来鉴别电商刷单。例如有人进来页面后一下就把页面拉到底部然后等待一段时间后购买，有人是慢慢的往下滚动页面，最后再购买。虽然他们在页面的停留时间一样，但明显第一个人更像是刷单的。</p> <p>页面访问深度计算过程稍微复杂一点：</p> <ol><li>用户进入页面时，记录当前时间、scrollTop 值、页面可视高度、页面总高度。</li> <li>用户滚动页面的那一刻，会触发 <code>scroll</code> 事件，在回调函数中用第一点得到的数据算出页面访问深度和停留时长。</li> <li>当用户滚动页面到某一点时，停下继续观看页面。这时记录当前时间、scrollTop 值、页面可视高度、页面总高度。</li> <li>重复第二点...</li></ol> <p>具体代码请看：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> timer
<span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> hasReport <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> pageHeight <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> scrollTop <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> viewportHeight <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageAccessHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> onScroll<span class="token punctuation">)</span>

    <span class="token function">onBeforeunload</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            startTime<span class="token operator">:</span> now<span class="token punctuation">,</span>
            duration<span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'page-access-height'</span><span class="token punctuation">,</span>
            pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> viewportHeight<span class="token punctuation">)</span> <span class="token operator">/</span> pageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 页面加载完成后初始化记录当前访问高度、时间</span>
    <span class="token function">executeAfterLoad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        startTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pageHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight
        scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
        viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">onScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasReport <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            startTime<span class="token operator">:</span> now<span class="token punctuation">,</span>
            duration<span class="token operator">:</span> now <span class="token operator">-</span> startTime<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'page-access-height'</span><span class="token punctuation">,</span>
            pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            value<span class="token operator">:</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token punctuation">(</span>scrollTop <span class="token operator">+</span> viewportHeight<span class="token punctuation">)</span> <span class="token operator">/</span> pageHeight<span class="token punctuation">)</span><span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        hasReport <span class="token operator">=</span> <span class="token boolean">false</span>
        startTime <span class="token operator">=</span> now
        pageHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight
        scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop
        viewportHeight <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight        
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">toPercent</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'100%'</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>val <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="用户点击"><a href="#用户点击" class="header-anchor">#</a> 用户点击</h3> <p>利用 <code>addEventListener()</code> 监听 <code>mousedown</code>、<code>touchstart</code> 事件，我们可以收集用户每一次点击区域的大小，点击坐标在整个页面中的具体位置，点击元素的内容等信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token string">'touchstart'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">eventType</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> timer
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
            timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target
                <span class="token keyword">const</span> <span class="token punctuation">{</span> top<span class="token punctuation">,</span> left <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    top<span class="token punctuation">,</span>
                    left<span class="token punctuation">,</span>
                    eventType<span class="token punctuation">,</span>
                    pageHeight<span class="token operator">:</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">,</span>
                    scrollTop<span class="token operator">:</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">,</span>
                    type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
                    subType<span class="token operator">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
                    target<span class="token operator">:</span> target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
                    paths<span class="token operator">:</span> event<span class="token punctuation">.</span>path<span class="token operator">?.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    startTime<span class="token operator">:</span> event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
                    pageURL<span class="token operator">:</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    outerHTML<span class="token operator">:</span> target<span class="token punctuation">.</span>outerHTML<span class="token punctuation">,</span>
                    innerHTML<span class="token operator">:</span> target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span>
                    width<span class="token operator">:</span> target<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">,</span>
                    height<span class="token operator">:</span> target<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">,</span>
                    viewport<span class="token operator">:</span> <span class="token punctuation">{</span>
                        width<span class="token operator">:</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span>
                        height<span class="token operator">:</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="页面跳转"><a href="#页面跳转" class="header-anchor">#</a> 页面跳转</h3> <p>利用 <code>addEventListener()</code> 监听 <code>popstate</code>、<code>hashchange</code> 页面跳转事件。需要注意的是调用<code>history.pushState()</code>或<code>history.replaceState()</code>不会触发<code>popstate</code>事件。只有在做出浏览器动作时，才会触发该事件，如用户点击浏览器的回退按钮（或者在Javascript代码中调用<code>history.back()</code>或者<code>history.forward()</code>方法）。同理，<code>hashchange</code> 也一样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">pageChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">from</span> <span class="token operator">=</span> <span class="token string">''</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">getPageURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token keyword">from</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'popstate'</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">from</span> <span class="token operator">=</span> to
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> oldURL <span class="token operator">=</span> <span class="token string">''</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newURL <span class="token operator">=</span> event<span class="token punctuation">.</span>newURL

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token keyword">from</span><span class="token operator">:</span> oldURL<span class="token punctuation">,</span>
            to<span class="token operator">:</span> newURL<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        oldURL <span class="token operator">=</span> newURL
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue-路由变更"><a href="#vue-路由变更" class="header-anchor">#</a> Vue 路由变更</h3> <p>Vue 可以利用 <code>router.beforeEach</code> 钩子进行路由变更的监听。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">onVueRouter</span><span class="token punctuation">(</span><span class="token parameter">router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 首次加载页面不用统计</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">from</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
            params<span class="token operator">:</span> to<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
            query<span class="token operator">:</span> to<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token function">lazyReportCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            data<span class="token punctuation">,</span>
            name<span class="token operator">:</span> to<span class="token punctuation">.</span>name <span class="token operator">||</span> to<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'behavior'</span><span class="token punctuation">,</span>
            subType<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'vue-router-change'</span><span class="token punctuation">,</span> <span class="token string">'pv'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            startTime<span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">from</span><span class="token operator">:</span> <span class="token keyword">from</span><span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            to<span class="token operator">:</span> to<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
            uuid<span class="token operator">:</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="数据上报"><a href="#数据上报" class="header-anchor">#</a> 数据上报</h2> <h3 id="上报方法"><a href="#上报方法" class="header-anchor">#</a> 上报方法</h3> <p>数据上报可以使用以下几种方式：</p> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">sendBeacon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer">XMLHttpRequest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>image</li></ul> <p>我写的简易 SDK 采用的是第一、第二种方式相结合的方式进行上报。利用 sendBeacon 来进行上报的优势非常明显。</p> <blockquote><p>使用 <strong><code>sendBeacon()</code></strong> 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。</p></blockquote> <p>在不支持 sendBeacon 的浏览器下我们可以使用 XMLHttpRequest 来进行上报。一个 HTTP 请求包含发送和接收两个步骤。其实对于上报来说，我们只要确保能发出去就可以了。也就是发送成功了就行，接不接收响应无所谓。为此，我做了个实验，在 beforeunload 用 XMLHttpRequest 传送了 30kb 的数据（一般的待上报数据很少会有这么大），换了不同的浏览器，都可以成功发出去。当然，这和硬件性能、网络状态也是有关联的。</p> <h3 id="上报时机"><a href="#上报时机" class="header-anchor">#</a> 上报时机</h3> <p>上报时机有三种：</p> <ol><li>采用 <code>requestIdleCallback/setTimeout</code> 延时上报。</li> <li>在 <code>beforeunload()</code> 回调函数里上报。</li> <li>缓存上报数据，达到一定数量后再上报。</li></ol> <p>建议将三种方式结合一起上报：</p> <ol><li>先缓存上报数据，缓存到一定数量后，利用 <code>requestIdleCallback/setTimeout</code> 延时上报。</li> <li>在页面离开时统一将未上报的数据进行上报。</li></ol> <p>仅看理论知识是比较难以理解的，为此我结合本章所讲的技术要点写了一个简单的<a href="https://github.com/woai3c/monitor-demo" target="_blank" rel="noopener noreferrer">监控 SDK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，可以用它来写一些简单的 DEMO，帮助加深理解。再结合本章一起阅读，效果更好。</p> <h2 id="前端监控部署"><a href="#前端监控部署" class="header-anchor">#</a> 前端监控部署</h2> <p>前面说的都是监控原理，但要实现还是得自己动手写代码。为了避免麻烦，我们可以用现有的工具 <a href="https://docs.sentry.io/" target="_blank" rel="noopener noreferrer">sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 去做这件事。</p> <p>sentry 是一个用 python 写的性能和错误监控工具，你可以使用 sentry 提供的服务（免费功能少），也可以自己部署服务。现在来看一下如何使用 sentry 提供的服务实现监控。</p> <h3 id="注册账号"><a href="#注册账号" class="header-anchor">#</a> 注册账号</h3> <p>打开 <code>https://sentry.io/signup/</code> 网站，进行注册。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/39d89dcae02f4762c778c3a1d0245c6b.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/3096c2c57c2964ab86fb08a685267f23.png" alt=""></p> <p>选择项目，这里用 Vue 做示例。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/89ce497139633f55fe1ca87ac809b4f5.png" alt=""></p> <h3 id="安装-sentry-依赖"><a href="#安装-sentry-依赖" class="header-anchor">#</a> 安装 sentry 依赖</h3> <p>选完项目，下面会有具体的 sentry 依赖安装指南。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/630d261f7fc6b097ab7ebc7c5ef0d3b6.png" alt=""></p> <p>根据提示，在你的 Vue 项目执行下面这段代码安装 sentry 所需的依赖。</p> <div class="language- extra-class"><pre class="language-text"><code>npm install --save @sentry/vue @sentry/tracing
</code></pre></div><p>再将下面的代码拷到你的 <code>main.js</code>，放在 <code>new Vue()</code> 之前。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Sentry <span class="token keyword">from</span> <span class="token string">'@sentry/vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Integrations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@sentry/tracing'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./router'</span>

Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    Vue<span class="token punctuation">,</span>
    dsn<span class="token operator">:</span> <span class="token string">'xxxxx'</span><span class="token punctuation">,</span>
    integrations<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">Integrations<span class="token punctuation">.</span>BrowserTracing</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            routingInstrumentation<span class="token operator">:</span> Sentry<span class="token punctuation">.</span><span class="token function">vueRouterInstrumentation</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span>
            tracingOrigins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// Set tracesSampleRate to 1.0 to capture 100%</span>
    <span class="token comment">// of transactions for performance monitoring.</span>
    <span class="token comment">// We recommend adjusting this value in production</span>
    tracesSampleRate<span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><p>然后点击第一步中的 <code>skip this onboarding</code>，进入控制台页面。</p> <p>如果忘了自己的 DSN，请点击左边的菜单栏选择 <code>Settings</code> -&gt; <code>Projects</code> -&gt; 点击自己的项目 -&gt; <code>Client Keys(DSN)</code>。</p> <h3 id="创建第一个错误"><a href="#创建第一个错误" class="header-anchor">#</a> 创建第一个错误</h3> <p>在你的 Vue 项目执行一个打印语句 <code>console.log(b)</code>。</p> <p>这时点开 sentry 主页的 issues 一项，可以发现有一个报错信息 <code>b is not defined</code>：</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/cab799f4c03a2b5f835cc26b97be0dd2.png" alt=""></p> <p>这个报错信息包含了错误的具体信息，还有你的 IP、浏览器信息等等。</p> <p>但奇怪的是，我们的浏览器控制台并没有输出报错信息。</p> <p>这是因为被 sentry 屏蔽了，所以我们需要加上一个选项 <code>logErrors: true</code>。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/f49a1653cc2512a09da56928e97cbd5f.png" alt=""></p> <p>然后再查看页面，发现控制台也有报错信息了：</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/3863d2ccca797f7ec2a2cb7bcad26299.png" alt=""></p> <h4 id="忽略错误"><a href="#忽略错误" class="header-anchor">#</a> 忽略错误</h4> <p>错误你想忽略某些错误，可以这样设置：</p> <div class="language-js extra-class"><pre class="language-js"><code>Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    ignoreErrors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 错误中含有 &quot;Non-Error promise rejection captured with keys&quot; 的错误事件将不会上报</span>
        <span class="token string">'Non-Error promise rejection captured with keys'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>或者这样设置：</p> <div class="language-js extra-class"><pre class="language-js"><code>Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeSend</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回 null 将不上传错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">?.</span>exception<span class="token operator">?.</span>values <span class="token operator">&amp;&amp;</span> event<span class="token operator">?.</span>exception<span class="token operator">?.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?.</span>value<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Non-Error promise rejection captured with keys'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 忽略未处理的 Promise 错误</span>
<span class="token function">beforeSend</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> hint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> values <span class="token operator">=</span> event<span class="token operator">?.</span>exception<span class="token operator">?.</span>values
    <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">&amp;&amp;</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?.</span>mechanism<span class="token operator">?.</span>type <span class="token operator">===</span> <span class="token string">'onunhandledrejection'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> event
<span class="token punctuation">}</span>
</code></pre></div><h3 id="上传-sourcemap"><a href="#上传-sourcemap" class="header-anchor">#</a> 上传 sourcemap</h3> <p>一般打包后的代码都是经过压缩的，如果没有 sourcemap，即使有报错信息，你也很难根据提示找到对应的源码在哪。</p> <p>下面来看一下如何上传 sourcemap。</p> <p>首先创建 auth token。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/6c0057d0deb1ce57b5e845d41f5c49d4.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b493b5b6405c5a5c7ad68969f81895ec.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/31dfb7a9565f2f618843822866993729.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/cf0a7ce7dd5ed7f68cd99a75b555b373.png" alt=""></p> <p>这个生成的 token 一会要用到。</p> <p>安装 <code>sentry-cli</code> 和 <code>@sentry/webpack-plugin</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>npm install sentry-cli-binary -g
npm install --save-dev @sentry/webpack-plugin
</code></pre></div><p>安装完上面两个插件后，在项目根目录创建一个 <code>.sentryclirc</code> 文件（不要忘了在 <code>.gitignore</code> 把这个文件添加上，以免暴露 token），内容如下：</p> <div class="language- extra-class"><pre class="language-text"><code>[auth]
token=xxx

[defaults]
url=https://sentry.io/
org=woai3c
project=woai3c
</code></pre></div><p>把 xxx 替换成刚才生成的 token。</p> <p><code>org</code> 是你的组织名称。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/1d584d4095b75d4e6d9feaa8193b31d5.png" alt=""></p> <p><code>project</code> 是你的项目名称，根据下面的提示可以找到。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/8c42a030a12aff493b950622207ea9bc.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/d9048286c883320243e69468f501617c.png" alt=""></p> <p>在项目下新建 <code>vue.config.js</code> 文件，把下面的内容填进去：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> SentryWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sentry/webpack-plugin'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    configureWebpack<span class="token operator">:</span> <span class="token punctuation">{</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">SentryWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                include<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 打包后的目录</span>
                ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token string">'vue.config.js'</span><span class="token punctuation">,</span> <span class="token string">'babel.config.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                release<span class="token operator">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只在生产环境下上传 sourcemap</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span><span class="token operator">?</span> config <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>填完以后，执行 <code>npm run build</code>，就可以看到 <code>sourcemap</code> 的上传结果了。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/0c228c1a8c9df7b22e1edc9928797d52.png" alt=""></p> <p>我们再来看一下没上传 sourcemap 和上传之后的报错信息对比。</p> <p><strong>未上传 sourcemap</strong></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/5010c62af2c3ff761b20180809037d49.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/56bde1012cd1bdd67cc928847d760c57.png" alt=""></p> <p><strong>已上传 sourcemap</strong></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/75c92e05d69c152aa0d694a3370537fe.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/65a59d58fe01d1c15621e287cf53ef47.png" alt=""></p> <p>可以看到，上传 sourcemap 后的报错信息更加准确。</p> <p><strong>注意</strong>：在 SentryWebpackPlugin 插件配置中，release 字段的值要和 <code>Sentry.init</code> 函数中的 release 字段的值一样。</p> <h3 id="切换中文环境和时区"><a href="#切换中文环境和时区" class="header-anchor">#</a> 切换中文环境和时区</h3> <p><img src="https://img-blog.csdnimg.cn/img_convert/0ea958f0b5f77979489f9bc2a2558e65.png" alt=""></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b5230bf8da8c86eb46a1b880dfae462c.png" alt=""></p> <p>选完刷新即可。</p> <h3 id="性能监控"><a href="#性能监控" class="header-anchor">#</a> 性能监控</h3> <p><img src="https://img-blog.csdnimg.cn/img_convert/72c4c1464e2510e6951a002a8208a30a.png" alt=""></p> <p>打开 performance 选项，就能看到你每个项目的运行情况。具体的参数解释请看文档 <a href="https://docs.sentry.io/product/performance/" target="_blank" rel="noopener noreferrer">Performance Monitoring<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>随着 web 技术的发展，现在前端项目的规模也越来越大。在监控系统的帮助下，我们可以更加清楚的了解项目的运行情况，根据采集到的错误数据和性能数据对项目做针对性的优化。</p> <p>下一章我们将讲解如何做性能优化。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <h3 id="性能监控-2"><a href="#性能监控-2" class="header-anchor">#</a> 性能监控</h3> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance_API" target="_blank" rel="noopener noreferrer">Performance API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceResourceTiming" target="_blank" rel="noopener noreferrer">PerformanceResourceTiming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Resource_Timing_API/Using_the_Resource_Timing_API" target="_blank" rel="noopener noreferrer">Using_the_Resource_Timing_API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener noreferrer">PerformanceTiming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://web.dev/metrics/" target="_blank" rel="noopener noreferrer">Metrics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://web.dev/evolving-cls/" target="_blank" rel="noopener noreferrer">evolving-cls<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://web.dev/custom-metrics/" target="_blank" rel="noopener noreferrer">custom-metrics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/GoogleChrome/web-vitals" target="_blank" rel="noopener noreferrer">web-vitals<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver" target="_blank" rel="noopener noreferrer">PerformanceObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element_timing_API" target="_blank" rel="noopener noreferrer">Element_timing_API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEventTiming" target="_blank" rel="noopener noreferrer">PerformanceEventTiming<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Timing-Allow-Origin" target="_blank" rel="noopener noreferrer">Timing-Allow-Origin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://web.dev/bfcache/" target="_blank" rel="noopener noreferrer">bfcache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer">XMLHttpRequest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/39292837" target="_blank" rel="noopener noreferrer">如何监控网页的卡顿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">sendBeacon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="错误监控"><a href="#错误监控" class="header-anchor">#</a> 错误监控</h3> <ul><li><a href="https://github.com/joeyguo/noerror" target="_blank" rel="noopener noreferrer">noerror<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/mozilla/source-map" target="_blank" rel="noopener noreferrer">source-map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="行为监控"><a href="#行为监控" class="header-anchor">#</a> 行为监控</h3> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/popstate_event" target="_blank" rel="noopener noreferrer">popstate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/hashchange_event" target="_blank" rel="noopener noreferrer">hashchange<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/introduction-to-front-end-engineering/06.html" class="prev">
        6. 自动化部署
      </a></span> <span class="next"><a href="/introduction-to-front-end-engineering/08.html">
        8. 性能优化（一）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/introduction-to-front-end-engineering/assets/js/app.a2b9a5b8.js" defer></script><script src="/introduction-to-front-end-engineering/assets/js/2.4a4753f4.js" defer></script><script src="/introduction-to-front-end-engineering/assets/js/15.97c6ce9d.js" defer></script><script src="/introduction-to-front-end-engineering/assets/js/7.85b148e3.js" defer></script>
  </body>
</html>
